<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Losowanie MikoÅ‚ajkowe ðŸŽ…</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #fafafa;
    margin: 2em;
  }
  textarea {
    width: 100%;
    margin: 0.5em 0;
    padding: 0.5em;
  }
  input {
    margin: 0.5em 0;
    padding: 0.5em;
  }
  button {
    padding: 0.7em 1.5em;
    margin-top: 1em;
    margin-bottom: 1em;
    cursor: pointer;
  }
  .result a {
    display: block;
    margin: 0.3em 0;
    word-break: break-all;
  }
  .exclusions {
    margin-top: 1em;
    padding: 1em;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  details {
    margin: 0.4em 0;
    background: #f0f0f0;
    padding: 0.5em 0.8em;
    border-radius: 5px;
  }
  summary {
    cursor: pointer;
    font-weight: bold;
    margin-bottom: 0.3em;
  }
  .checkbox-group {
    display: block;
    gap: 0.3em 1em;
    margin-left: 1em;
  }
  label {
    display: flex;
    align-items: center;
    gap: 0.3em;
    font-size: 0.95em;
  }
  
  #result {
    margin-top: 1.5em;
  }

  .result-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 8px 12px;
    margin-bottom: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    gap: 10px;
  }

  .result-name {
    font-weight: 600;
    white-space: nowrap;
  }

  .result-link {
    flex-grow: 1;
    color: #1565c0;
    text-decoration: none;
    word-break: break-all;
  }
  .result-link:hover {
    text-decoration: underline;
  }

  .copy-btn {
    background: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 4px 10px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background 0.2s, transform 0.1s;
  }
  .copy-btn:hover {
    background: #e0e0e0;
    transform: scale(1.03);
  }
  .copy-btn.copied {
    background: #c8e6c9 !important;
  }
</style>
</head>
<body>
  <h2>Losowanie MikoÅ‚ajkowe ðŸŽ…</h2>
  <p>Podaj listÄ™ uczestnikÃ³w (po jednym w linii):</p>
  <textarea id="uczestnicy" rows="6" placeholder="Jan Kowalski&#10;Anna Nowak&#10;Piotr ZieliÅ„ski"></textarea>

  <button id="generujZakazy">Generuj listÄ™ wykluczeÅ„</button>
  <div id="listaZakazow" class="exclusions"></div>

  <button id="losuj" style="display:none;">Wylosuj</button>

  <div class="result" id="result"></div>

<script>
function losuj(uczestnicy, zakazy, maxProb = 10000) {
  for (let i = 0; i < maxProb; i++) {
    const obdarowani = [...uczestnicy];
    obdarowani.sort(() => Math.random() - 0.5);
    const wynik = {};
    let poprawne = true;

    for (let j = 0; j < uczestnicy.length; j++) {
      const osoba = uczestnicy[j];
      const wylosowany = obdarowani[j];
      if (osoba === wylosowany) { poprawne = false; break; }
      if (zakazy[osoba]?.includes(wylosowany)) { poprawne = false; break; }
      wynik[osoba] = wylosowany;
    }

    if (poprawne) return wynik;
  }
  return null;
}

function encodeBase64Unicode(str) {
  const bytes = new TextEncoder().encode(str);
  let binary = "";
  bytes.forEach(b => binary += String.fromCharCode(b));
  const base64 = btoa(binary);
  return base64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

document.getElementById("generujZakazy").addEventListener("click", () => {
  const uczestnicy = document.getElementById("uczestnicy").value
    .split("\n").map(s => s.trim()).filter(Boolean);
  const listaDiv = document.getElementById("listaZakazow");
  listaDiv.innerHTML = "";

  if (uczestnicy.length < 2) {
    listaDiv.innerHTML = "<p style='color:red'>Podaj co najmniej dwie osoby.</p>";
    return;
  }

  uczestnicy.forEach(osoba => {
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.textContent = osoba;
    details.appendChild(summary);

    const boxGroup = document.createElement("div");
    boxGroup.className = "checkbox-group";

    uczestnicy.filter(o => o !== osoba).forEach(innaOsoba => {
      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = innaOsoba;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(innaOsoba));
      boxGroup.appendChild(label);
    });

    details.appendChild(boxGroup);
    listaDiv.appendChild(details);
  });

  document.getElementById("losuj").style.display = "inline-block";
});

document.getElementById("losuj").addEventListener("click", () => {
  const uczestnicy = document.getElementById("uczestnicy").value
    .split("\n").map(s => s.trim()).filter(Boolean);
  
  const zakazy = {};
  document.querySelectorAll("#listaZakazow details").forEach(detail => {
    const osoba = detail.querySelector("summary").textContent;
    const wykluczeni = [];
    detail.querySelectorAll("input[type='checkbox']:checked").forEach(chk => {
      wykluczeni.push(chk.value);
    });
    zakazy[osoba] = wykluczeni;
  });

  const wynik = losuj(uczestnicy, zakazy);
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  if (!wynik) {
    resultDiv.innerHTML = "<p style='color:red'>Nie udaÅ‚o siÄ™ znaleÅºÄ‡ poprawnego losowania.</p>";
    return;
  }

  resultDiv.innerHTML = "<h3>Wyniki (linki dla kaÅ¼dej osoby):</h3>";
  const baseUrl = window.location.href;
  for (const [osoba, wylosowany] of Object.entries(wynik)) {
    const message = `W tym roku na MikoÅ‚ajki wylosowaÅ‚eÅ›/aÅ›: \n${wylosowany} ðŸŽ`;
    const encoded_person = encodeBase64Unicode(osoba);
    const encoded = encodeBase64Unicode(message);
    const link = `losowanie?person=${encoded_person}&data=${encoded}`;
    const full_link = `${baseUrl}${link}`;
    const row = document.createElement("div");
    row.className = "result-row";

    const nameSpan = document.createElement("span");
    nameSpan.className = "result-name";
    nameSpan.textContent = `${osoba} â†’ `;

    const a = document.createElement("a");
    a.className = "result-link";
    a.href = link;
    a.textContent = full_link;

    const copyBtn = document.createElement("button");
    copyBtn.className = "copy-btn";
    copyBtn.textContent = "ðŸ“‹ Kopiuj";

    // ObsÅ‚uga kopiowania
    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(full_link);
        copyBtn.textContent = "âœ… Skopiowano!";
        copyBtn.classList.add("copied");
        setTimeout(() => {
          copyBtn.textContent = "ðŸ“‹ Kopiuj";
          copyBtn.classList.remove("copied");
        }, 1500);
      } catch {
        alert("Nie udaÅ‚o siÄ™ skopiowaÄ‡ linku ðŸ˜¢");
      }
    });

    // SkÅ‚adanie elementÃ³w
    row.appendChild(nameSpan);
    row.appendChild(a);
    row.appendChild(copyBtn);
    resultDiv.appendChild(row);
  }
});
</script>
</body>
</html>
